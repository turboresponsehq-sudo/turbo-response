<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Turbo Response AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            --accent-cyan: #06b6d4;
            --accent-blue: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --card-bg: rgba(15, 23, 42, 0.8);
            --border-glow: rgba(6, 182, 212, 0.2);
            --user-bubble: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
            --ai-bubble: rgba(30, 41, 59, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary-gradient);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-glow);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            text-decoration: none;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            word-wrap: break-word;
        }

        .message.ai .message-bubble {
            background: var(--ai-bubble);
            border: 1px solid var(--border-glow);
            border-radius: 20px 20px 20px 5px;
        }

        .message.user .message-bubble {
            background: var(--user-bubble);
            color: white;
            border-radius: 20px 20px 5px 20px;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: var(--ai-bubble);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            max-width: fit-content;
        }

        .typing-indicator.show {
            display: block;
        }

        .typing-dots {
            display: flex;
            gap: 5px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--accent-cyan);
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .input-container {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 15px;
            padding: 15px;
        }

        .input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            padding: 12px 15px;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 150px;
        }

        #messageInput:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .send-button {
            background: var(--user-bubble);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .send-button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-upload-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: var(--card-bg);
            border: 2px dashed var(--border-glow);
            border-radius: 15px;
            text-align: center;
        }

        .file-upload-section.show {
            display: block;
        }

        .upload-button {
            background: var(--accent-cyan);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
        }

        .skip-button {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            padding: 12px 30px;
            font-size: 1rem;
            cursor: pointer;
        }

        .contact-form {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 15px;
        }

        .contact-form.show {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid var(--border-glow);
            border-radius: 10px;
            padding: 12px 15px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .submit-button {
            background: var(--user-bubble);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="logo">âš¡ TURBO RESPONSE</a>
    </div>

    <div class="chat-container">
        <div class="messages-container" id="messagesContainer">
            <!-- Messages will be added here -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="file-upload-section" id="fileUploadSection">
            <h3>Upload Evidence (Optional)</h3>
            <p style="color: var(--text-secondary); margin: 10px 0;">
                Upload any relevant documents, photos, or screenshots (max 5 files)
            </p>
            <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;">
            <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                Choose Files
            </button>
            <button class="skip-button" onclick="skipUpload()">Skip This Step</button>
            <div id="fileList" style="margin-top: 15px; color: var(--text-secondary);"></div>
            <button class="upload-button" id="uploadButton" style="display: none;" onclick="uploadFiles()">
                Upload Files
            </button>
        </div>

        <div class="contact-form" id="contactForm">
            <h3 style="margin-bottom: 20px;">Let's Get Started</h3>
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="nameInput" required>
            </div>
            <div class="form-group">
                <label>Email Address *</label>
                <input type="email" id="emailInput" required>
            </div>
            <div class="form-group">
                <label>Phone Number *</label>
                <input type="tel" id="phoneInput" required>
            </div>
            <div class="form-group">
                <label>Best Time to Call</label>
                <select id="bestTimeInput">
                    <option value="">Any time</option>
                    <option value="morning">Morning (8am-12pm)</option>
                    <option value="afternoon">Afternoon (12pm-5pm)</option>
                    <option value="evening">Evening (5pm-9pm)</option>
                </select>
            </div>
            <button class="submit-button" onclick="submitLead()">Submit</button>
        </div>

        <div class="input-container">
            <div class="input-area">
                <textarea 
                    id="messageInput" 
                    placeholder="Tell me about your situation..."
                    onkeypress="handleKeyPress(event)"
                ></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let conversationId = null;
        let currentPhase = 'initial';
        let uploadedFiles = [];

        // Add welcome message on load
        window.addEventListener('load', () => {
            addMessage('ai', 'Welcome to Turbo Response. I\'m here to analyze your situation and help you understand your rights and available options. Let\'s start by getting the details of what\'s happening.\n\nPlease describe your situation in your own words.');
        });

        function addMessage(role, content) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typingIndicator').classList.add('show');
            document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        function disableInput() {
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
        }

        function enableInput() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').focus();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            disableInput();
            showTyping();
            
            try {
                if (!sessionId) {
                    // Start new conversation
                    const response = await fetch('/api/chat/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ story: message })
                    });
                    
                    const data = await response.json();
                    sessionId = data.session_id;
                    conversationId = data.conversation_id;
                    currentPhase = 'questions';
                    
                    hideTyping();
                    addMessage('ai', data.message);
                    enableInput();
                } else {
                    // Continue conversation
                    const response = await fetch('/api/chat/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            session_id: sessionId,
                            message: message 
                        })
                    });
                    
                    const data = await response.json();
                    hideTyping();
                    addMessage('ai', data.message);
                    
                    if (data.phase === 'evidence_upload') {
                        currentPhase = 'upload';
                        document.getElementById('fileUploadSection').classList.add('show');
                        disableInput();
                    } else {
                        enableInput();
                    }
                }
            } catch (error) {
                hideTyping();
                addMessage('ai', 'I apologize, but I encountered an error. Please try again.');
                enableInput();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 5) {
                alert('Maximum 5 files allowed');
                return;
            }
            
            uploadedFiles = files;
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<strong>Selected files:</strong><br>' + 
                files.map(f => f.name).join('<br>');
            document.getElementById('uploadButton').style.display = 'block';
        });

        async function uploadFiles() {
            if (uploadedFiles.length === 0) {
                skipUpload();
                return;
            }
            
            const formData = new FormData();
            formData.append('session_id', sessionId);
            uploadedFiles.forEach(file => {
                formData.append('files', file);
            });
            
            try {
                showTyping();
                const response = await fetch('/api/chat/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                hideTyping();
                addMessage('ai', `Thank you. I've received ${data.count} file(s). Let me analyze everything now...`);
                
                document.getElementById('fileUploadSection').classList.remove('show');
                await analyzeCase();
            } catch (error) {
                hideTyping();
                addMessage('ai', 'Error uploading files. Let me proceed with the analysis based on what you\'ve told me.');
                await analyzeCase();
            }
        }

        async function skipUpload() {
            document.getElementById('fileUploadSection').classList.remove('show');
            addMessage('ai', 'No problem. Let me analyze your situation based on what you\'ve shared...');
            await analyzeCase();
        }

        async function analyzeCase() {
            showTyping();
            
            try {
                const response = await fetch('/api/chat/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                const data = await response.json();
                hideTyping();
                addMessage('ai', data.message);
                
                currentPhase = 'contact';
                document.getElementById('contactForm').classList.add('show');
            } catch (error) {
                hideTyping();
                addMessage('ai', 'I apologize for the error. Please refresh and try again.');
            }
        }

        async function submitLead() {
            const name = document.getElementById('nameInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const bestTime = document.getElementById('bestTimeInput').value;
            
            if (!name || !email || !phone) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                showTyping();
                const response = await fetch('/api/chat/submit-lead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        name: name,
                        email: email,
                        phone: phone,
                        best_time_to_call: bestTime
                    })
                });
                
                const data = await response.json();
                hideTyping();
                addMessage('ai', data.message);
                
                document.getElementById('contactForm').classList.remove('show');
                disableInput();
            } catch (error) {
                hideTyping();
                addMessage('ai', 'Error submitting your information. Please try again.');
            }
        }
    </script>
</body>
</html>
